import fs from "fs"
import path from "path"
import { PROGRESS_FILE, ANIME_DOWNLOAD_DIR, BASE_DIR } from "./constants.js"
import { getWorkspaceFiles } from "./utils.js"
import { getStorageInfo, cleanupTempFiles, savedChats } from "./storage.js"
import { sendFileList, handleFileUpload, handleFileDelete } from "./files.js"
import { parseYouTubeCommand, searchYouTubeVideos, sendVideoSearchResults } from "./youtube.js"
import { handleAnimeCommand } from "./anime.js"
import { activeDownloads } from "./progress.js"
import { handlePinterestCommand } from "./pinterest.js"
import { parseYouTubeChannelCommand, searchYouTubeChannels, sendChannelSearchResults } from "./youtube_channels.js"
import { handleMusicCommand } from "./music.js"
import { performanceManager } from "./performance.js"

// Safety functions for bot management
export async function restartBot() {
  console.log("üîÑ Bot restart requested...")

  activeDownloads.clear()

  try {
    if (fs.existsSync(PROGRESS_FILE)) {
      fs.unlinkSync(PROGRESS_FILE)
    }
  } catch (error) {
    console.log("Could not clean progress file:", error.message)
  }

  console.log("üîÑ Terminating current process...")
  process.exit(0)
}

export async function stopBot() {
  console.log("üõë Bot stop requested...")

  activeDownloads.clear()

  try {
    if (fs.existsSync(PROGRESS_FILE)) {
      fs.unlinkSync(PROGRESS_FILE)
    }
  } catch (error) {
    console.log("Could not clean progress file:", error.message)
  }

  console.log("üõë Stopping bot...")
  process.exit(1)
}

// Optimized welcome message
export async function sendWelcomeMessage(sock, remoteJid) {
  const welcomeText = `ü§ñ *Welcome to Enhanced WhatsApp Bot!*

‚ú® *I can help you with:*
‚Ä¢ üìÅ File sharing and management
‚Ä¢ üé• YouTube video downloads  
‚Ä¢ üéå Enhanced anime downloads with automation
‚Ä¢ üéµ High-quality music downloads

*üöÄ Enhanced Features:*
‚Ä¢ Real-time progress tracking
‚Ä¢ Automatic file sending
‚Ä¢ Episode range support
‚Ä¢ File size display

*Quick Commands:*
‚Ä¢ */help* - Show all commands
‚Ä¢ */files* - Browse files
‚Ä¢ */ys <query>* - Search YouTube
‚Ä¢ */yc <query>* - Search YouTube channels
‚Ä¢ */music <query>* - Search and download music
‚Ä¢ */img <query>* - Search Pinterest images
‚Ä¢ */anime <query>* - Search anime

üìù *Type /help for detailed instructions!*`

  try {
    await sock.sendMessage(remoteJid, { text: welcomeText })
  } catch (error) {
    console.error("Error sending welcome message:", error)
  }
}

// Optimized broadcast with parallel processing
export async function broadcastWelcomeMessage(sock, force = false) {
  if (!force && savedChats.size === 0) {
    console.log("üì¢ No saved chats to broadcast to")
    return
  }

  const welcomeText = `ü§ñ *Enhanced WhatsApp Bot Online!*

‚ú® *Available Commands:*
‚Ä¢ */help* - Show all commands
‚Ä¢ */files* - Browse files
‚Ä¢ */upload <number>* - Send file
‚Ä¢ */delete <number>* - Delete file
‚Ä¢ */ys <query> -<number>* - Search YouTube
‚Ä¢ */yc <query> -<number>* - Search YouTube channels
‚Ä¢ */music <query> <number>* - Search and download music
‚Ä¢ */img <query> <number>* - Search Pinterest images
‚Ä¢ */anime <query>* - Interactive anime downloads
‚Ä¢ */anime <name> <episode> <quality>* - Automated download
‚Ä¢ */anime <name> <start-end> <quality>* - Range download
‚Ä¢ */storage* - Check storage
‚Ä¢ */cleanup* - Clean temp files
‚Ä¢ */setcookies* - Set YouTube cookies
‚Ä¢ */restart* - Restart bot
‚Ä¢ */stop* - Stop bot

*üöÄ New Features:*
‚Ä¢ Real-time progress tracking
‚Ä¢ Automatic file sending
‚Ä¢ Episode range support (1-25)
‚Ä¢ High-quality music downloads
‚Ä¢ Optimized performance

*Examples:*
‚Ä¢ */anime "one piece" 124 1080* - Download episode 124
‚Ä¢ */music believer* - Download "Believer" as MP3`

  console.log(`üì¢ Broadcasting to ${savedChats.size} chats...`)

  // Convert to array for batch processing
  const chatArray = Array.from(savedChats)
  const messages = chatArray.map((jid) => ({
    remoteJid: jid,
    content: { text: welcomeText },
  }))

  try {
    const results = await performanceManager.sendMessagesBatch(sock, messages)
    const successCount = results.flat().filter((result) => result.status === "fulfilled" && result.value).length
    const failCount = results.flat().length - successCount

    console.log(`üì¢ Broadcast complete: ${successCount} sent, ${failCount} failed`)
  } catch (error) {
    console.error("Broadcast failed:", error)
  }
}

// New function to handle YouTube cookies
export async function handleSetCookies(sock, remoteJid, userStates) {
  try {
    await sock.sendMessage(remoteJid, {
      text:
        `üç™ *YouTube Cookies Setup*\n\n` +
        `Please send your YouTube cookies in Netscape format (plain text).\n\n` +
        `The cookies should start with:\n` +
        `\`\`\`\n# Netscape HTTP Cookie File\n...\`\`\`\n\n` +
        `Reply with "cancel" to cancel this operation.`,
    })

    userStates.set(remoteJid, {
      state: "waiting_for_cookies",
      timestamp: Date.now(),
    })
  } catch (error) {
    console.error("Error in handleSetCookies:", error)
    await sock.sendMessage(remoteJid, { text: `‚ùå Error: ${error.message}` })
  }
}

// Function to save YouTube cookies
export async function saveCookies(sock, remoteJid, cookiesText, userStates) {
  try {
    if (cookiesText.toLowerCase() === "cancel") {
      userStates.delete(remoteJid)
      await sock.sendMessage(remoteJid, { text: "‚ùå Cookie setup cancelled." })
      return
    }

    // Basic validation - check if it looks like Netscape format
    if (!cookiesText.includes("# Netscape HTTP Cookie File") && !cookiesText.includes(".youtube.com")) {
      await sock.sendMessage(remoteJid, {
        text:
          `‚ùå Invalid cookie format. Cookies should be in Netscape format and contain YouTube domains.\n\n` +
          `Please try again or type "cancel" to cancel.`,
      })
      return
    }

    const cookiesPath = path.join(BASE_DIR, "youtube_cookies.txt")

    // Create a backup of the existing cookies file if it exists
    if (fs.existsSync(cookiesPath)) {
      const backupPath = path.join(BASE_DIR, `youtube_cookies_backup_${Date.now()}.txt`)
      fs.copyFileSync(cookiesPath, backupPath)
      console.log(`Created backup of cookies at ${backupPath}`)
    }

    // Write the new cookies
    fs.writeFileSync(cookiesPath, cookiesText, "utf8")

    // Set file permissions to read/write for owner only (more secure)
    try {
      fs.chmodSync(cookiesPath, 0o600)
    } catch (error) {
      console.log("Could not set file permissions:", error.message)
    }

    userStates.delete(remoteJid)
    await sock.sendMessage(remoteJid, {
      text:
        `‚úÖ YouTube cookies saved successfully!\n\n` +
        `üîí The cookies file has been updated and secured.\n` +
        `üé¨ You can now download age-restricted and private videos.\n\n` +
        `Note: The cookies will remain unchanged until you update them again.`,
    })
  } catch (error) {
    console.error("Error saving cookies:", error)
    await sock.sendMessage(remoteJid, { text: `‚ùå Error saving cookies: ${error.message}` })
    userStates.delete(remoteJid)
  }
}

// Optimized command handler
export async function handleCommand(sock, messageInfo, command, userStates) {
  const { remoteJid } = messageInfo
  const commandParts = command.split(" ")
  const mainCommand = commandParts[0].toLowerCase()

  switch (mainCommand) {
    case "/anime":
      if (commandParts.length < 2) {
        await sock.sendMessage(remoteJid, {
          text: `‚ùå Please provide an anime name.

*Usage:*
‚Ä¢ */anime <name>* - Interactive search
‚Ä¢ */anime <name> <episode> <quality>* - Auto download
‚Ä¢ */anime <name> <start-end> <quality>* - Range download

*Examples:*
‚Ä¢ */anime naruto* - Search Naruto
‚Ä¢ */anime "one piece" 124 1080* - Download episode 124
‚Ä¢ */anime "death note" 1-6 720* - Download episodes 1-6

*Quality options:* 480, 720, 1080`,
        })
        break
      }

      await handleAnimeCommand(sock, remoteJid, commandParts, userStates)
      break

    case "/files":
      const files = getWorkspaceFiles()
      if (files.length === 0) {
        await sock.sendMessage(remoteJid, { text: "üìÅ No files found in the files directory." })
        return
      }

      userStates.set(remoteJid, { state: "selecting_file", files: files })
      await sendFileList(sock, remoteJid, files)
      break

    case "/upload":
      if (commandParts.length < 2) {
        await sock.sendMessage(remoteJid, {
          text: "‚ùå Please specify file number.\n\n*Usage:* /upload <number>\n*Example:* /upload 1\n\nüí° Use /files first to see available files",
        })
        break
      }

      const uploadFileNumber = commandParts[1]
      await handleFileUpload(sock, messageInfo, uploadFileNumber, userStates)
      break

    case "/delete":
      if (commandParts.length < 2) {
        await sock.sendMessage(remoteJid, {
          text: `‚ùå Please specify file number(s).

*Usage:* 
‚Ä¢ /delete <number> - Delete single file
‚Ä¢ /delete <number>,<number> - Delete multiple files

*Examples:* 
‚Ä¢ /delete 3 - Delete third file
‚Ä¢ /delete 1,3,5 - Delete files 1, 3, and 5

üí° Use /files first to see available files`,
        })
        break
      }

      const deleteFileNumbers = commandParts[1]
      await handleFileDelete(sock, messageInfo, deleteFileNumbers, userStates)
      break

    case "/ys":
      if (commandParts.length < 2) {
        await sock.sendMessage(remoteJid, {
          text: `‚ùå Please provide a search query.

*Usage Examples:*
‚Ä¢ /ys "dream manhunt" 5 - Search with quotes
‚Ä¢ /ys minecraft -10 - Search with dash format
‚Ä¢ /ys speedrun 3 - Simple search

üìù Format: /ys <query> -<number>
üìù Or: /ys "<query>" <number>`,
        })
        break
      }

      try {
        const { query, maxResults } = parseYouTubeCommand(commandParts)

        if (!query) {
          await sock.sendMessage(remoteJid, { text: "‚ùå Please provide a valid search query." })
          break
        }

        await sock.sendPresenceUpdate("composing", remoteJid)
        await sock.sendMessage(remoteJid, { text: `üîç Searching: "${query}" (${maxResults} results)...` })

        const searchResult = await searchYouTubeVideos(query, maxResults)

        if (searchResult.success && searchResult.videos.length > 0) {
          userStates.set(remoteJid, {
            state: "video_search_results",
            searchResults: searchResult.videos,
          })
          await sendVideoSearchResults(sock, remoteJid, searchResult.videos)
        } else {
          await sock.sendMessage(remoteJid, {
            text: `‚ùå YouTube Search Failed: ${searchResult.error || "No videos found."}`,
          })
        }
        await sock.sendPresenceUpdate("available", remoteJid)
      } catch (error) {
        console.error("YouTube search error:", error)
        await sock.sendMessage(remoteJid, { text: `‚ùå Search failed: ${error.message}` })
        await sock.sendPresenceUpdate("available", remoteJid)
      }
      break

    case "/yc":
      if (commandParts.length < 2) {
        await sock.sendMessage(remoteJid, {
          text: `‚ùå Please provide a channel search query.

*Usage Examples:*
‚Ä¢ /yc "MrBeast" 5 - Search for MrBeast channels
‚Ä¢ /yc pewdiepie -10 - Search with dash format
‚Ä¢ /yc "Kurzgesagt" 3 - Search with quotes

üìù Format: /yc <query> -<number>
üìù Or: /yc "<query>" <number>

üí° After finding channels, reply with number to see latest videos
Example: 1 (shows 10 latest videos) or 1 15 (shows 15 latest videos)`,
        })
        break
      }

      try {
        const { query, maxResults } = parseYouTubeChannelCommand(commandParts)

        if (!query) {
          await sock.sendMessage(remoteJid, { text: "‚ùå Please provide a valid search query." })
          break
        }

        await sock.sendPresenceUpdate("composing", remoteJid)
        await sock.sendMessage(remoteJid, { text: `üîç Searching channels: "${query}" (${maxResults} results)...` })

        const searchResult = await searchYouTubeChannels(query, maxResults)

        if (searchResult.success && searchResult.channels.length > 0) {
          userStates.set(remoteJid, {
            state: "channel_search_results",
            searchResults: searchResult.channels,
          })
          await sendChannelSearchResults(sock, remoteJid, searchResult.channels)
        } else {
          await sock.sendMessage(remoteJid, {
            text: `‚ùå YouTube Channel Search Failed: ${searchResult.error || "No channels found."}`,
          })
        }
        await sock.sendPresenceUpdate("available", remoteJid)
      } catch (error) {
        console.error("YouTube channel search error:", error)
        await sock.sendMessage(remoteJid, { text: `‚ùå Search failed: ${error.message}` })
        await sock.sendPresenceUpdate("available", remoteJid)
      }
      break

    case "/music":
      if (commandParts.length < 2) {
        await sock.sendMessage(remoteJid, {
          text: `‚ùå Please provide a music search query.

*Usage:*
‚Ä¢ */music <song name>* - Search for music (default 5 results)
‚Ä¢ */music <song name> <number>* - Search with specific count

*Examples:*
‚Ä¢ */music believer* - Search for "Believer"
‚Ä¢ */music "imagine dragons" 3* - Search 3 Imagine Dragons songs
‚Ä¢ */music sunrise 10* - Search 10 "Sunrise" tracks

*Features:*
üéµ High-quality MP3 (320kbps)
üñºÔ∏è Embedded album art
üìù Metadata included
üì§ Auto-sent after download`,
        })
        break
      }

      await handleMusicCommand(sock, remoteJid, commandParts, userStates)
      break

    case "/img":
      if (commandParts.length < 2) {
        await sock.sendMessage(remoteJid, {
          text: `‚ùå Please provide a search query.

*Usage:*
‚Ä¢ */img <query>* - Get 10 images (default)
‚Ä¢ */img <query> <number>* - Get specific number of images

*Examples:*
‚Ä¢ */img one piece* - Get 10 One Piece images
‚Ä¢ */img naruto 20* - Get 20 Naruto images
‚Ä¢ */img anime wallpaper 5* - Get 5 anime wallpapers

*Note:* Maximum 50 images per request`,
        })
        break
      }

      await handlePinterestCommand(sock, remoteJid, commandParts)
      break

    case "/restart":
      await sock.sendMessage(remoteJid, { text: "üîÑ Restarting bot... All processes will be stopped and restarted." })
      await restartBot()
      break

    case "/stop":
      await sock.sendMessage(remoteJid, { text: "üõë Stopping bot... Core bash terminal will be stopped." })
      await stopBot()
      break

    case "/setcookies":
      await handleSetCookies(sock, remoteJid, userStates)
      break

    case "/help":
      const helpText = `ü§ñ *Enhanced WhatsApp Bot Help*

*üìã Available Commands:*
‚Ä¢ */files* - Browse files
‚Ä¢ */upload <number>* - Send file by number
‚Ä¢ */delete <number>* - Delete file by number
‚Ä¢ */delete <number>,<number>* - Delete multiple files
‚Ä¢ */ys <query> -<number>* - Search YouTube videos
‚Ä¢ */yc <query> -<number>* - Search YouTube channels
‚Ä¢ */music <query> <number>* - Search and download music as MP3
‚Ä¢ */img <query> <number>* - Search Pinterest images
‚Ä¢ */anime <query>* - Interactive anime downloads
‚Ä¢ */anime <name> <episode> <quality>* - Automated download
‚Ä¢ */anime <name> <start-end> <quality>* - Range download
‚Ä¢ */storage* - Check storage usage
‚Ä¢ */cleanup* - Clean temporary files
‚Ä¢ */setcookies* - Set YouTube cookies manually
‚Ä¢ */restart* - Restart bot (stops all processes)
‚Ä¢ */stop* - Stop bot core
‚Ä¢ */help* - Show this help

*üöÄ Performance Features:*
‚Ä¢ Parallel processing for faster results
‚Ä¢ Optimized connection pooling
‚Ä¢ Real-time progress tracking
‚Ä¢ Automatic file sending after download
‚Ä¢ Batch operations for multiple items
‚Ä¢ Minimal delays for faster response
‚Ä¢ Memory optimization
‚Ä¢ Error handling optimization

*üñºÔ∏è Pinterest Examples:*
‚Ä¢ */img one piece* - Get 10 One Piece images
‚Ä¢ */img naruto 20* - Get 20 Naruto images
‚Ä¢ */img anime wallpaper 5* - Get 5 anime wallpapers

*üì∫ YouTube Examples:*
‚Ä¢ */ys minecraft 5* - Search 5 Minecraft videos
‚Ä¢ */yc "MrBeast" 3* - Search 3 MrBeast channels
‚Ä¢ After channel search: *1 15* - Get 15 latest videos from first channel

*üéµ Music Examples:*
‚Ä¢ */music believer* - Search for "Believer"
‚Ä¢ */music "imagine dragons" 3* - Search 3 Imagine Dragons songs
‚Ä¢ */music sunrise 10* - Search 10 "Sunrise" tracks`

      await sock.sendMessage(remoteJid, { text: helpText })
      break

    case "/storage":
      try {
        const cookiesPath = path.join(BASE_DIR, "youtube_cookies.txt")
        const cookiesExist = fs.existsSync(cookiesPath)
        let cookiesInfo = "‚ùå Not found"

        if (cookiesExist) {
          try {
            const stats = fs.statSync(cookiesPath)
            const lastModified = new Date(stats.mtime).toLocaleString()
            cookiesInfo = `‚úÖ Found (Last updated: ${lastModified})`
          } catch (error) {
            cookiesInfo = "‚úÖ Found (Could not read details)"
          }
        }

        const storageInfo = getStorageInfo()
        const storageMessage =
          `üìä *Storage Information:*\n\n` +
          `üìÅ *Files Directory:* ${storageInfo.workspaceSize}\n` +
          `üóÇÔ∏è *Files Count:* ${storageInfo.filesCount} files\n` +
          `üóëÔ∏è *Temp Directory:* ${storageInfo.tempSize}\n` +
          `üéå *Anime Downloads:* ${storageInfo.animeSize}\n` +
          `üéµ *Music Downloads:* ${storageInfo.musicSize}\n` +
          `üìç *Anime Path:* ${ANIME_DOWNLOAD_DIR}\n` +
          `üìç *Music Path:* downloads/\n\n` +
          `üç™ *YouTube Cookies:* ${cookiesInfo}\n` +
          `üíæ *Saved Chats:* ${storageInfo.savedChatsCount} chats\n` +
          `üìä *Active Downloads:* ${activeDownloads.size} sessions\n` +
          `‚ö° *Performance:* Optimized with parallel processing\n\n` +
          `üí° Use /cleanup to free up temporary files\n` +
          `üîß Use /restart if bot is stuck or lagging\n` +
          `üõë Use /stop to stop core bash terminal`
        await sock.sendMessage(remoteJid, { text: storageMessage })
      } catch (error) {
        await sock.sendMessage(remoteJid, { text: `‚ùå Storage check failed: ${error.message}` })
      }
      break

    case "/cleanup":
      try {
        await sock.sendMessage(remoteJid, { text: "üßπ Starting cleanup..." })
        const tempFilesDeleted = await cleanupTempFiles()

        try {
          if (fs.existsSync(PROGRESS_FILE)) {
            fs.unlinkSync(PROGRESS_FILE)
          }
        } catch (error) {
          console.log("Could not clean progress file:", error.message)
        }

        await sock.sendMessage(remoteJid, {
          text: `‚úÖ Cleanup completed!\n\nüóëÔ∏è Removed ${tempFilesDeleted} temporary files\nüíæ Files directory preserved\nüéå Anime downloads preserved\nüéµ Music downloads preserved\nüìä Progress tracking reset`,
        })
      } catch (error) {
        await sock.sendMessage(remoteJid, { text: `‚ùå Cleanup error: ${error.message}` })
      }
      break

    case "/broadcast":
      if (savedChats.size === 0) {
        await sock.sendMessage(remoteJid, { text: "üì¢ No saved chats to broadcast to." })
        break
      }

      await sock.sendMessage(remoteJid, {
        text: `üì¢ Starting optimized broadcast to ${savedChats.size} chats...`,
      })

      await broadcastWelcomeMessage(sock, true)

      await sock.sendMessage(remoteJid, {
        text: `‚úÖ Broadcast completed!`,
      })
      break

    default:
      await sock.sendMessage(remoteJid, { text: "‚ùì Unknown command. Type /help for available commands." })
  }
}
